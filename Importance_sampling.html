

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Importance Sampling &mdash; x-psi 3.1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=796a81b5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Module generator tutorial" href="Module_generator_tutorial.html" />
    <link rel="prev" title="Multiple imaging" href="Multiple_imaging.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            x-psi
              <img src="_static/xpsilogo_small.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQs and common problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="applications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="HPC_systems.html">HPC systems</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="todo.html">Future</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Team and acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="citation.html">Citation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Start_here.html">Start here</a></li>
<li class="toctree-l1"><a class="reference internal" href="XPSI_101.html">X-PSI 101 - For Beginners</a></li>
<li class="toctree-l1"><a class="reference internal" href="Modeling.html">Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Instrument_synergy.html">Instrument synergy</a></li>
<li class="toctree-l1"><a class="reference internal" href="Hot_region_complexity.html">Hot region complexity</a></li>
<li class="toctree-l1"><a class="reference internal" href="Global_surface_emission.html">Global surface emission</a></li>
<li class="toctree-l1"><a class="reference internal" href="Surface_radiation_field_tools.html">Surface radiation field tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="Modeling_without_statistics.html">Modeling (without statistics)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Polarization.html">Polarization</a></li>
<li class="toctree-l1"><a class="reference internal" href="Post-processing.html">Post-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="Emitting_patterns_2Dprojection.html">Emitting Patterns 2D Projection</a></li>
<li class="toctree-l1"><a class="reference internal" href="Accretion_disk.html">Accretion disk</a></li>
<li class="toctree-l1"><a class="reference internal" href="Multiple_imaging.html">Multiple imaging</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Importance Sampling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Performing-Importance-Sampling-with-X-PSI">Performing Importance Sampling with X-PSI</a></li>
<li class="toctree-l2"><a class="reference internal" href="#1.-Model-Update">1. Model Update</a></li>
<li class="toctree-l2"><a class="reference internal" href="#2.-Prior-Update">2. Prior Update</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Module_generator_tutorial.html">Module generator tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example_script_and_modules.html">Example script and modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example_job.html">Example job</a></li>
<li class="toctree-l1"><a class="reference internal" href="x_p_sbi.html">Posterior Inference using SBI</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="likelihood_api.html">Likelihood API</a></li>
<li class="toctree-l1"><a class="reference internal" href="extension_modules.html">Extension modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="posterior_api.html">Posterior API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">x-psi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Importance Sampling</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/Importance_sampling.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Importance-Sampling">
<h1>Importance Sampling<a class="headerlink" href="#Importance-Sampling" title="Link to this heading"></a></h1>
<p>This notebook will walk you through how to perform importance sampling using X-PSI</p>
<section id="Performing-Importance-Sampling-with-X-PSI">
<h2>Performing Importance Sampling with X-PSI<a class="headerlink" href="#Performing-Importance-Sampling-with-X-PSI" title="Link to this heading"></a></h2>
<p>Importance sampling (calculating new posterior distribution based on the already existing samples) can be performed using X-PSI under the following circumstances:</p>
<ol class="arabic">
<li><p class="rubric" id="model-update">Model Update:</p>
<ul class="simple">
<li><p>The model itself has changed, which implies a modification of the likelihood function.</p></li>
<li><p>However, note that the importance sampling results become less accurate for larger likelihood changes.</p></li>
</ul>
</li>
<li><p class="rubric" id="change-in-parameter-priors">Change in Parameter Priors:</p>
<ul class="simple">
<li><p>The prior for one or more parameters has been modified.</p></li>
<li><p>However, the new priors must still lie within the hypervolume of the original prior distribution, and the original sampling needs to have produced enough samples around the likeliest region of the new prior.</p></li>
</ul>
</li>
<li><p class="rubric" id="both-changes">Both Changes:</p>
<ul class="simple">
<li><p>Both the prior and the model have been updated simultaneously.</p></li>
</ul>
</li>
</ol>
</section>
<section id="1.-Model-Update">
<h2>1. Model Update<a class="headerlink" href="#1.-Model-Update" title="Link to this heading"></a></h2>
<p><strong>For the new model, we changed the spin frequency from 314.0 Hz (which was used to generate the data) to 310.0 Hz (this is technically not the correct model, it’s just an example). One reason to adjust only the frequency in the model while keeping the data unchanged could arise from inadvertently using a frequency different from the one used to fold the data, only to realize this discrepancy after performing the run (with the wrong frequency).</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import math
import xpsi
from xpsi.Sample import importance
from xpsi.global_imports import gravradius
import sys

from collections import OrderedDict
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
/=============================================\
| X-PSI: X-ray Pulse Simulation and Inference |
|---------------------------------------------|
|                Version: 3.0.0               |
|---------------------------------------------|
|      https://xpsi-group.github.io/xpsi      |
\=============================================/

Imported emcee version: 3.1.6
Imported PyMultiNest.
Imported UltraNest.
Warning: Cannot import torch and test SBI_wrapper.
Imported GetDist version: 1.5.3
Imported nestcheck version: 0.2.1
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>path=&quot;../../examples/examples_fast/&quot;
sys.path.append(path)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture
# Let&#39;s import the old and the new models
from Modules import main as old_model               # The spin in main is 314.0 Hz
from Modules import main_IS_likelihood as new_model # The spin in main_IS_likelihood is 310.0 Hz
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def derive_names(model):
    out = str(model.likelihood)
    outA = out.split(&#39;\n&#39;)
    outA = outA[2:-1]
    names = []
    for i in range(len(outA)):
        a = outA[i]
        ind_end = a.find(&#39;:&#39;)
        if a[:ind_end].find(&#39; &#39;)&lt;0:
            names.append(a[:ind_end])
    return names

names = derive_names(old_model)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>names
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;mass&#39;,
 &#39;radius&#39;,
 &#39;distance&#39;,
 &#39;cos_inclination&#39;,
 &#39;p__phase_shift&#39;,
 &#39;p__super_colatitude&#39;,
 &#39;p__super_radius&#39;,
 &#39;p__super_temperature&#39;]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Doing importance sampling

# Commenting this as it takes a bit of time to run
######################
# importance(new_model.likelihood,
#                   old_model.likelihood,
#                   &#39;../../examples/examples_fast/Outputs/ST_live_1000_eff_0.3_seed42&#39;,
#                   names = names,
#                   likelihood_change = True,
#                   prior_change = False,
#                   weight_threshold=1.0e-30,
#                   overwrite=True)
</pre></div>
</div>
</div>
<p><strong>Running the cell above will generate a file called, ST_live_1000_eff_0.3_seed42_importance_sampled_likelihood_change.txt that contains the new posteriors.</strong></p>
<p><strong>Now let’s plot what the new posteriors look like compared to the old ones.</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Getdist settings
getdist_kde_settings = {&#39;ignore_rows&#39;: 0,
                         &#39;min_weight_ratio&#39;: 1.0e-10,
                         &#39;contours&#39;: [0.683, 0.954, 0.997],
                         &#39;credible_interval_threshold&#39;: 0.001,
                         &#39;range_ND_contour&#39;: 0,
                         &#39;range_confidence&#39;: 0.001,
                         &#39;fine_bins&#39;: 1024,
                         &#39;smooth_scale_1D&#39;: 0.4,
                         &#39;num_bins&#39;: 100,
                         &#39;boundary_correction_order&#39;: 1,
                         &#39;mult_bias_correction_order&#39;: 1,
                         &#39;smooth_scale_2D&#39;: 0.4,
                         &#39;max_corr_2D&#39;: 0.99,
                         &#39;fine_bins_2D&#39;: 512,
                         &#39;num_bins_2D&#39;: 40}
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Settings names, bounds and labels
old_model.names=[&#39;mass&#39;,&#39;radius&#39;,&#39;distance&#39;,&#39;cos_inclination&#39;,&#39;p__phase_shift&#39;,
          &#39;p__super_colatitude&#39;,&#39;p__super_radius&#39;,&#39;p__super_temperature&#39;]

# We will use the same bounds used during sampling
old_model.bounds = {&#39;mass&#39;:(1.0,1.6),
             &#39;radius&#39;:(10,13),
             &#39;distance&#39;:(0.5,2.0),
             &#39;cos_inclination&#39;:(0,1),
             &#39;p__phase_shift&#39;:(-0.25, 0.75),
             &#39;p__super_colatitude&#39;:(0.001, math.pi/2 - 0.001),
             &#39;p__super_radius&#39;:(0.001, math.pi/2.0 - 0.001),
             &#39;p__super_temperature&#39;:(6., 7.)}

# Now the labels
old_model.labels = {&#39;mass&#39;: r&quot;M\;\mathrm{[M}_{\odot}\mathrm{]}&quot;,
              &#39;radius&#39;: r&quot;R_{\mathrm{eq}}\;\mathrm{[km]}&quot;,
              &#39;distance&#39;: r&quot;D \;\mathrm{[kpc]}&quot;,
              &#39;cos_inclination&#39;: r&quot;\cos(i)&quot;,
              &#39;p__phase_shift&#39;: r&quot;\phi_{p}\;\mathrm{[cycles]}&quot;,
              &#39;p__super_colatitude&#39;: r&quot;\Theta_{spot}\;\mathrm{[rad]}&quot;,
              &#39;p__super_radius&#39;: r&quot;\zeta_{spot}\;\mathrm{[rad]}&quot;,
              &#39;p__super_temperature&#39;: r&quot;\mathrm{log10}(T_{spot}\;[\mathrm{K}])&quot;}

old_model.names +=[&#39;compactness&#39;]
old_model.bounds[&#39;compactness&#39;]=(gravradius(1.0)/16.0, 1.0/3.0)
old_model.labels[&#39;compactness&#39;]= r&quot;M/R_{\mathrm{eq}}&quot;
<br/><br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>new_model.names = old_model.names
new_model.bounds = old_model.bounds
new_model.labels = old_model.labels
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>precisions = {&#39;mass&#39;: 2,
             &#39;radius&#39;: 2,
             &#39;distance&#39;: 2,
             &#39;cos_inclination&#39;: 2,
             &#39;p__phase_shift&#39;: 3,
             &#39;p__super_colatitude&#39;: 2,
             &#39;p__super_radius&#39;: 2,
             &#39;p__super_temperature&#39;: 2,
             &#39;compactness&#39;: 2}
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Loading old run
old_model.runs = xpsi.Runs.load_runs(ID=&#39;Old likelihood&#39;,
                               run_IDs=[&#39;run&#39;],
                               roots=[&#39;ST_live_1000_eff_0.3_seed42&#39;],
                               base_dirs=[&#39;../../examples/examples_fast/Outputs/&#39;],
                               use_nestcheck=[False],
                               kde_settings=getdist_kde_settings,
                               likelihood=old_model.likelihood,
                               names=old_model.names,
                               bounds=old_model.bounds,
                               labels=old_model.labels,
                               implementation=&#39;multinest&#39;,
                               precisions=precisions,
                               overwrite_transformed=True)

# Loading new run
new_model.runs = xpsi.Runs.load_runs(ID=&#39;New likelihood&#39;,
                               run_IDs=[&#39;run&#39;],
                               roots=[&#39;ST_live_1000_eff_0.3_seed42_importance_sampled_likelihood_change&#39;],
                               base_dirs=[&#39;../../examples/examples_fast/Outputs/&#39;],
                               use_nestcheck=[False],
                               kde_settings=getdist_kde_settings,
                               likelihood=new_model.likelihood,
                               names=new_model.names,
                               bounds=new_model.bounds,
                               labels=new_model.labels,
                               implementation=&#39;multinest&#39;,
                               precisions=precisions,
                               overwrite_transformed=True)
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pp = xpsi.PostProcessing.CornerPlotter([old_model.runs, new_model.runs])

_ = pp.plot(
     params=old_model.names,#[&quot;mass&quot;,&quot;radius&quot;],

     IDs=OrderedDict([(&#39;Old likelihood&#39;, [&#39;run&#39;,]),(&#39;New likelihood&#39;, [&#39;run&#39;,])]),
     prior_density=False,
     KL_divergence=True,
     ndraws=5e4,
     combine=False, combine_all=True, only_combined=False, overwrite_combined=True,
     param_plot_lims={},
     bootstrap_estimators=False,
     bootstrap_density=False,
     n_simulate=200,
     crosshairs=False,
     write=False,
     ext=&#39;.png&#39;,
     maxdots=3000,
     root_filename=&#39;run&#39;,
     credible_interval_1d=True,
     annotate_credible_interval=True,
     credible_interval_1d_all_show=True,
     show_vband=None,
     compute_all_intervals=False,
     sixtyeight=True,
     axis_tick_x_rotation=45.0,
     num_plot_contours=3,
     subplot_size=4.0,
     legend_corner_coords=(0.675,0.8),
     legend_frameon=False,
     scale_attrs=OrderedDict([(&#39;legend_fontsize&#39;, 3.0),
                              (&#39;axes_labelsize&#39;, 2.35),
                              (&#39;axes_fontsize&#39;, &#39;axes_labelsize&#39;),
                             ]
                            ),
     colormap=&#39;Reds&#39;,
     shaded=False,
     shade_root_index=-1,
     rasterized_shade=True,
     no_ylabel=True,
     no_ytick=True,
     lw=4.0,
     lw_1d=4.0,
     filled=False,
     normalize=True,
     veneer=True,
     line_colors=[&#39;darkgreen&#39;, &quot;orangered&quot;],
     tqdm_kwargs={&#39;disable&#39;: False},
     lengthen=2.0,
     embolden=1.0,
     ci_gap=0.16,
     nx=500)
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Executing posterior density estimation...
Curating set of runs for posterior plotting...
Run set curated.
Constructing lower-triangle posterior density plot via Gaussian KDE:
plotting:  [&#39;mass&#39;, &#39;radius&#39;]
plotting:  [&#39;mass&#39;, &#39;distance&#39;]
plotting:  [&#39;mass&#39;, &#39;cos_inclination&#39;]
plotting:  [&#39;mass&#39;, &#39;p__phase_shift&#39;]
plotting:  [&#39;mass&#39;, &#39;p__super_colatitude&#39;]
plotting:  [&#39;mass&#39;, &#39;p__super_radius&#39;]
plotting:  [&#39;mass&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;mass&#39;, &#39;compactness&#39;]
plotting:  [&#39;radius&#39;, &#39;distance&#39;]
plotting:  [&#39;radius&#39;, &#39;cos_inclination&#39;]
plotting:  [&#39;radius&#39;, &#39;p__phase_shift&#39;]
plotting:  [&#39;radius&#39;, &#39;p__super_colatitude&#39;]
plotting:  [&#39;radius&#39;, &#39;p__super_radius&#39;]
plotting:  [&#39;radius&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;radius&#39;, &#39;compactness&#39;]
plotting:  [&#39;distance&#39;, &#39;cos_inclination&#39;]
plotting:  [&#39;distance&#39;, &#39;p__phase_shift&#39;]
plotting:  [&#39;distance&#39;, &#39;p__super_colatitude&#39;]
plotting:  [&#39;distance&#39;, &#39;p__super_radius&#39;]
plotting:  [&#39;distance&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;distance&#39;, &#39;compactness&#39;]
plotting:  [&#39;cos_inclination&#39;, &#39;p__phase_shift&#39;]
plotting:  [&#39;cos_inclination&#39;, &#39;p__super_colatitude&#39;]
plotting:  [&#39;cos_inclination&#39;, &#39;p__super_radius&#39;]
plotting:  [&#39;cos_inclination&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;cos_inclination&#39;, &#39;compactness&#39;]
plotting:  [&#39;p__phase_shift&#39;, &#39;p__super_colatitude&#39;]
plotting:  [&#39;p__phase_shift&#39;, &#39;p__super_radius&#39;]
plotting:  [&#39;p__phase_shift&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;p__phase_shift&#39;, &#39;compactness&#39;]
plotting:  [&#39;p__super_colatitude&#39;, &#39;p__super_radius&#39;]
plotting:  [&#39;p__super_colatitude&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;p__super_colatitude&#39;, &#39;compactness&#39;]
plotting:  [&#39;p__super_radius&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;p__super_radius&#39;, &#39;compactness&#39;]
plotting:  [&#39;p__super_temperature&#39;, &#39;compactness&#39;]
Veneering spines and axis ticks...
Veneered.
Adding 1D marginal credible intervals...
Plotting credible regions for posterior Old likelihood...
Added 1D marginal credible intervals.
Adding 1D marginal credible intervals...
Plotting credible regions for posterior New likelihood...
Added 1D marginal credible intervals.
Constructed lower-triangle posterior density plot.
Posterior density estimation complete.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/Importance_sampling_18_1.png" src="_images/Importance_sampling_18_1.png" />
</div>
</div>
</section>
<section id="2.-Prior-Update">
<h2>2. Prior Update<a class="headerlink" href="#2.-Prior-Update" title="Link to this heading"></a></h2>
<p><strong>In the Module folder, we made a file called main_IS_prior.py. The model is the same, but the only change was the prior. In the CustomPrior_IS.py file, the mass prior changed (look at the density method) to :math:`M sim U(1., 1.6)` to :math:`M sim N(1.4, 0.01^2)`. The new mass distribution is truncated at :math:`2.5sigma`. The radius also changed from :math:`R_{mathrm{eq}} sim U(10., 13.)` to :math:`R_{mathrm{eq}} sim N(11.5, 0.01^2)`. The new radius distribution is truncated at
:math:`1.5sigma`.</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%capture
from Modules import main_IS_prior as new_model  # The prior density has changed in CustomPrior_IS compared to CustomPrior
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Doing importance sampling

importance(new_model.likelihood,
                   old_model.likelihood,
                   &#39;../../examples/examples_fast/Outputs/ST_live_1000_eff_0.3_seed42&#39;,
                   names = names,
                   likelihood_change = False,
                   prior_change = True,
                   weight_threshold=1.0e-30,
                   overwrite=True)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Importance sampling commencing...
Cross-checking parameter names...
Loading samples...
Importance sample fraction = 84.817%.
Distributing workload amongst 1 MPI processes...
Renormalising weights...
Writing to disk...
Restoring likelihood-object parameter update protocol attributes...
Importance sampling completed.
</pre></div></div>
</div>
<p><strong>Running the cell above will generate a file called, ST_live_1000_eff_0.3_seed42_importance_sampled_prior_change.txt that contains the new posteriors.</strong></p>
<p><strong>Now let’s plot the new posteriors and compare them to the old ones.</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>new_model.names = old_model.names
new_model.bounds = old_model.bounds
new_model.labels = old_model.labels
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>old_model.runs = xpsi.Runs.load_runs(ID=&#39;Old prior&#39;,
                               run_IDs=[&#39;run&#39;],
                               roots=[&#39;ST_live_1000_eff_0.3_seed42&#39;],
                               base_dirs=[&#39;../../examples/examples_fast/Outputs/&#39;],
                               use_nestcheck=[False],
                               kde_settings=getdist_kde_settings,
                               likelihood=old_model.likelihood,
                               names=old_model.names,
                               bounds=old_model.bounds,
                               labels=old_model.labels,
                               implementation=&#39;multinest&#39;,
                               precisions=precisions,
                               overwrite_transformed=True)

new_model.runs = xpsi.Runs.load_runs(ID=&#39;New prior&#39;,
                               run_IDs=[&#39;run&#39;],
                               roots=[&#39;ST_live_1000_eff_0.3_seed42_importance_sampled_prior_change&#39;],
                               base_dirs=[&#39;../../examples/examples_fast/Outputs/&#39;],
                               use_nestcheck=[False],
                               kde_settings=getdist_kde_settings,
                               likelihood=new_model.likelihood,
                               names=new_model.names,
                               bounds=new_model.bounds,
                               labels=new_model.labels,
                               implementation=&#39;multinest&#39;,
                               precisions=precisions,
                               overwrite_transformed=True)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING:root:outlier fraction 0.0027829313543599257
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pp = xpsi.PostProcessing.CornerPlotter([old_model.runs, new_model.runs])

_ = pp.plot(
     params=old_model.names,#[&quot;mass&quot;,&quot;radius&quot;],

     IDs=OrderedDict([(&#39;Old prior&#39;, [&#39;run&#39;,]),(&#39;New prior&#39;, [&#39;run&#39;,])]),
     prior_density=False,
     KL_divergence=True,
     ndraws=5e4,
     combine=False, combine_all=True, only_combined=False, overwrite_combined=True,
     param_plot_lims={},
     bootstrap_estimators=False,
     bootstrap_density=False,
     n_simulate=200,
     crosshairs=False,
     write=False,
     ext=&#39;.png&#39;,
     maxdots=3000,
     root_filename=&#39;run&#39;,
     credible_interval_1d=True,
     annotate_credible_interval=True,
     credible_interval_1d_all_show=True,
     show_vband=None,
     compute_all_intervals=False,
     sixtyeight=True,
     axis_tick_x_rotation=45.0,
     num_plot_contours=3,
     subplot_size=4.0,
     legend_corner_coords=(0.675,0.8),
     legend_frameon=False,
     scale_attrs=OrderedDict([(&#39;legend_fontsize&#39;, 3.0),
                              (&#39;axes_labelsize&#39;, 2.35),
                              (&#39;axes_fontsize&#39;, &#39;axes_labelsize&#39;),
                             ]
                            ),
     colormap=&#39;Reds&#39;,
     shaded=False,
     shade_root_index=-1,
     rasterized_shade=True,
     no_ylabel=True,
     no_ytick=True,
     lw=4.0,
     lw_1d=4.0,
     filled=False,
     normalize=True,
     veneer=True,
     line_colors=[&#39;darkgreen&#39;, &quot;orangered&quot;],
     tqdm_kwargs={&#39;disable&#39;: False},
     lengthen=2.0,
     embolden=1.0,
     ci_gap=0.16,
     nx=500)
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Executing posterior density estimation...
Curating set of runs for posterior plotting...
Run set curated.
Constructing lower-triangle posterior density plot via Gaussian KDE:
plotting:  [&#39;mass&#39;, &#39;radius&#39;]
plotting:  [&#39;mass&#39;, &#39;distance&#39;]
plotting:  [&#39;mass&#39;, &#39;cos_inclination&#39;]
plotting:  [&#39;mass&#39;, &#39;p__phase_shift&#39;]
plotting:  [&#39;mass&#39;, &#39;p__super_colatitude&#39;]
plotting:  [&#39;mass&#39;, &#39;p__super_radius&#39;]
plotting:  [&#39;mass&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;mass&#39;, &#39;compactness&#39;]
plotting:  [&#39;radius&#39;, &#39;distance&#39;]
plotting:  [&#39;radius&#39;, &#39;cos_inclination&#39;]
plotting:  [&#39;radius&#39;, &#39;p__phase_shift&#39;]
plotting:  [&#39;radius&#39;, &#39;p__super_colatitude&#39;]
plotting:  [&#39;radius&#39;, &#39;p__super_radius&#39;]
plotting:  [&#39;radius&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;radius&#39;, &#39;compactness&#39;]
plotting:  [&#39;distance&#39;, &#39;cos_inclination&#39;]
plotting:  [&#39;distance&#39;, &#39;p__phase_shift&#39;]
plotting:  [&#39;distance&#39;, &#39;p__super_colatitude&#39;]
plotting:  [&#39;distance&#39;, &#39;p__super_radius&#39;]
plotting:  [&#39;distance&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;distance&#39;, &#39;compactness&#39;]
plotting:  [&#39;cos_inclination&#39;, &#39;p__phase_shift&#39;]
plotting:  [&#39;cos_inclination&#39;, &#39;p__super_colatitude&#39;]
plotting:  [&#39;cos_inclination&#39;, &#39;p__super_radius&#39;]
plotting:  [&#39;cos_inclination&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;cos_inclination&#39;, &#39;compactness&#39;]
plotting:  [&#39;p__phase_shift&#39;, &#39;p__super_colatitude&#39;]
plotting:  [&#39;p__phase_shift&#39;, &#39;p__super_radius&#39;]
plotting:  [&#39;p__phase_shift&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;p__phase_shift&#39;, &#39;compactness&#39;]
plotting:  [&#39;p__super_colatitude&#39;, &#39;p__super_radius&#39;]
plotting:  [&#39;p__super_colatitude&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;p__super_colatitude&#39;, &#39;compactness&#39;]
plotting:  [&#39;p__super_radius&#39;, &#39;p__super_temperature&#39;]
plotting:  [&#39;p__super_radius&#39;, &#39;compactness&#39;]
plotting:  [&#39;p__super_temperature&#39;, &#39;compactness&#39;]
Veneering spines and axis ticks...
Veneered.
Adding 1D marginal credible intervals...
Plotting credible regions for posterior Old prior...
Added 1D marginal credible intervals.
Adding 1D marginal credible intervals...
Plotting credible regions for posterior New prior...
Added 1D marginal credible intervals.
Constructed lower-triangle posterior density plot.
Posterior density estimation complete.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/Importance_sampling_27_1.png" src="_images/Importance_sampling_27_1.png" />
</div>
</div>
<p><strong>This is it. That’s a very simple example.</strong></p>
<p><strong>Alternatively you can also use the tools found in xpsi/utilities/ImportanceSample.py to perform importance sampling.</strong></p>
<p>It can be used e.g. in the following way:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>f = open(&quot;config_importance_sampling.ini&quot;, &quot;w&quot;)
f.write(&quot;--name-original-main=main\n&quot;)
f.write(&quot;--name-importance-sample-main=main_IS_prior\n&quot;)
f.write(&quot;--path-to-mains=../../examples/examples_fast/Modules/\n&quot;)
f.write(&quot;--path-to-outputs=../../examples/examples_fast/Outputs/\n&quot;)
f.write(&quot;--output-root-name=ST_live_1000_eff_0.3_seed42\n&quot;)
f.write(&quot;--names=mass radius distance cos_inclination p__phase_shift p__super_colatitude p__super_radius p__super_temperature\n&quot;)
f.write(&quot;--likelihood-change=False\n&quot;)
f.write(&quot;--prior-change=True\n&quot;)
f.write(&quot;--weight-threshold=1e-30\n&quot;)
f.write(&quot;--overwrite=True\n&quot;)
f.close()
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!python ../../xpsi/utilities/ImportanceSample.py @config_importance_sampling.ini
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
WARNING: Please be aware that ERRORS can arise if relative paths are used in the main.py file (to point to the config file) or in the config.ini file (to point to other files used in the analysis).
/=============================================\
| X-PSI: X-ray Pulse Simulation and Inference |
|---------------------------------------------|
|                Version: 3.0.0               |
|---------------------------------------------|
|      https://xpsi-group.github.io/xpsi      |
\=============================================/

Imported emcee version: 3.1.6
Imported PyMultiNest.
Imported UltraNest.
Warning: Cannot import torch and test SBI_wrapper.
Imported GetDist version: 1.5.3
Imported nestcheck version: 0.2.1
Setting channels for event data...
Channels set.
Setting channels for loaded instrument response (sub)matrix...
Channels set.
No parameters supplied... empty subspace created.
Creating parameter:
    &gt; Named &#34;phase_shift&#34; with fixed value 0.000e+00.
    &gt; The phase shift for the signal, a periodic parameter [cycles].
Creating parameter:
    &gt; Named &#34;frequency&#34; with fixed value 3.140e+02.
    &gt; Spin frequency [Hz].
Creating parameter:
    &gt; Named &#34;mass&#34; with bounds [1.000e+00, 1.600e+00].
    &gt; Gravitational mass [solar masses].
Creating parameter:
    &gt; Named &#34;radius&#34; with bounds [1.000e+01, 1.300e+01].
    &gt; Coordinate equatorial radius [km].
Creating parameter:
    &gt; Named &#34;distance&#34; with bounds [5.000e-01, 2.000e+00].
    &gt; Earth distance [kpc].
Creating parameter:
    &gt; Named &#34;cos_inclination&#34; with bounds [0.000e+00, 1.000e+00].
    &gt; Cosine of Earth inclination to rotation axis.
Creating parameter:
    &gt; Named &#34;super_colatitude&#34; with bounds [1.000e-03, 1.570e+00].
    &gt; The colatitude of the centre of the superseding region [radians].
Creating parameter:
    &gt; Named &#34;super_radius&#34; with bounds [1.000e-03, 1.570e+00].
    &gt; The angular radius of the (circular) superseding region [radians].
Creating parameter:
    &gt; Named &#34;phase_shift&#34; with bounds [-2.500e-01, 7.500e-01].
    &gt; The phase of the hot region, a periodic parameter [cycles].
Creating parameter:
    &gt; Named &#34;super_temperature&#34; with bounds [6.000e+00, 7.000e+00].
    &gt; log10(superseding region effective temperature [K]).
Creating parameter:
    &gt; Named &#34;mode_frequency&#34; with fixed value 3.140e+02.
    &gt; Coordinate frequency of the mode of radiative asymmetry in the
photosphere that is assumed to generate the pulsed signal [Hz].
No parameters supplied... empty subspace created.
Checking likelihood and prior evaluation before commencing sampling...
Not using ``allclose`` function from NumPy.
Using fallback implementation instead.
Checking closeness of likelihood arrays:
-3.1603740790e+04 | -3.1603740790e+04 .....
Closeness evaluated.
Log-likelihood value checks passed on root process.
Checks passed.
Setting channels for event data...
Channels set.
Setting channels for loaded instrument response (sub)matrix...
Channels set.
No parameters supplied... empty subspace created.
Creating parameter:
    &gt; Named &#34;phase_shift&#34; with fixed value 0.000e+00.
    &gt; The phase shift for the signal, a periodic parameter [cycles].
Creating parameter:
    &gt; Named &#34;frequency&#34; with fixed value 3.140e+02.
    &gt; Spin frequency [Hz].
Creating parameter:
    &gt; Named &#34;mass&#34; with bounds [1.000e+00, 1.600e+00].
    &gt; Gravitational mass [solar masses].
Creating parameter:
    &gt; Named &#34;radius&#34; with bounds [1.000e+01, 1.300e+01].
    &gt; Coordinate equatorial radius [km].
Creating parameter:
    &gt; Named &#34;distance&#34; with bounds [5.000e-01, 2.000e+00].
    &gt; Earth distance [kpc].
Creating parameter:
    &gt; Named &#34;cos_inclination&#34; with bounds [0.000e+00, 1.000e+00].
    &gt; Cosine of Earth inclination to rotation axis.
Creating parameter:
    &gt; Named &#34;super_colatitude&#34; with bounds [1.000e-03, 1.570e+00].
    &gt; The colatitude of the centre of the superseding region [radians].
Creating parameter:
    &gt; Named &#34;super_radius&#34; with bounds [1.000e-03, 1.570e+00].
    &gt; The angular radius of the (circular) superseding region [radians].
Creating parameter:
    &gt; Named &#34;phase_shift&#34; with bounds [-2.500e-01, 7.500e-01].
    &gt; The phase of the hot region, a periodic parameter [cycles].
Creating parameter:
    &gt; Named &#34;super_temperature&#34; with bounds [6.000e+00, 7.000e+00].
    &gt; log10(superseding region effective temperature [K]).
Creating parameter:
    &gt; Named &#34;mode_frequency&#34; with fixed value 3.140e+02.
    &gt; Coordinate frequency of the mode of radiative asymmetry in the
photosphere that is assumed to generate the pulsed signal [Hz].
No parameters supplied... empty subspace created.
Checking likelihood and prior evaluation before commencing sampling...
Not using ``allclose`` function from NumPy.
Using fallback implementation instead.
Checking closeness of likelihood arrays:
-3.1603740790e+04 | -3.1603740790e+04 .....
Closeness evaluated.
Log-likelihood value checks passed on root process.
Checks passed.
Importance sampling commencing...
Cross-checking parameter names...
Loading samples...
Importance sample fraction = 84.817%.
Distributing workload amongst 1 MPI processes...
Renormalising weights...
Writing to disk...
Restoring likelihood-object parameter update protocol attributes...
Importance sampling completed.
</pre></div></div>
</div>
<p>This will create exactly the same importance sampled output file as the prior-change example above.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Multiple_imaging.html" class="btn btn-neutral float-left" title="Multiple imaging" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Module_generator_tutorial.html" class="btn btn-neutral float-right" title="Module generator tutorial" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2025 the X-PSI Core Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>